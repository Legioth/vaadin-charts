<!--
@license
Copyright (c) 2017 Vaadin Ltd.
Commercial Vaadin Add-On License Version 3, available at https://vaadin.com/license/cval-3
-->

<!--
`<vaadin-chart>` is a Polymer 2 element.

```html
<vaadin-chart>
</vaadin-chart>
```

@element vaadin-chart
@demo demo/index.html
-->

<link rel="import" href="../polymer/polymer-element.html">
<script src="../highcharts/highcharts.js"></script>

<dom-module id="vaadin-chart">
  <template>
    <style>
       :host {
        display: block;
      }
    </style>
    <div id="chart" style="height:100%; width:100%;"></div>
  </template>

  <script>
    if (!Polymer.Element) {
      throw new Error(`Unexpected Polymer version ${Polymer.version} is used, expected v2.0.0 or later.`);
    }

    /**
     * `new-chart`
     * POC of new chart element
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class VaadinChart extends Polymer.Element {
      static get is() {
        return 'vaadin-chart';
      }

      static get properties() {
        return {
          title: String,
          subtitle: String,
          xLabels: Array,
          data: Array,
          configuration: Object
        };
      }

      constructor() {
        super();
        this._initialized = false;
      }

      connectedCallback() {
        super.connectedCallback();
        //draw chart with initial config
        Polymer.RenderStatus.beforeNextRender(this, function () {
          const conf = this._computeConfiguration();
          if (!this.configuration) {
            this.configuration = Highcharts.chart(this.$.chart, conf);
          }
        });

      }

      update(changes) {
        if (typeof changes === 'string') {
          try {
            changes = JSON.parse(changes);
          } catch (e) {
            //Invalid json
            return;
          }
        }
        if (this.configuration) {
          if (changes.series) {
            changes.series.forEach(this._addSeries.bind(this));
            changes.series = undefined;
          }
          this.configuration.update(changes);
        } else {
          this.configuration = Highcharts.chart(this.$.chart, changes);
        }
      }

      _addSeries(series) {
        this.configuration && this.configuration.addSeries(series);
      }

      _computeConfiguration() {
        const result = {
          title: { text: this.title },
          subtitle: { text: this.subtitle },
          credits: {
            enabled: false
          }
        };
        if (this.data) {
          result.series = [{ data: this.data }];
        }
        if (this.xLabels) {
          result.xAxis = [{ categories: this.xLabels }];
        }
        console.log(result);
        return result;
      }
    }

    customElements.define(VaadinChart.is, VaadinChart);
  </script>
</dom-module>