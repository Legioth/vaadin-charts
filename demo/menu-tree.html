<link rel="import" href="../../polymer/polymer.html">

<!--
A tree menu for selecting categories and demos.
-->
<dom-module id="menu-tree">

    <style>

        .category-items {
            /* Approximation of the max height needed */
            max-height: 1500px;

            -webkit-transition: max-height 0.3s;
            -moz-transition: max-height 0.3s;
            -ms-transition: max-height 0.3s;
            -o-transition: max-height 0.3s;
            transition: max-height 0.3s;

            overflow: hidden;
        }

        .category {
          position: relative;
        }

        .category.open .category-items.menu-tree {
          margin-bottom: 10px;
        }

        .category.closed .category-items {
            max-height: 0px;
        }

        .category.closed .tree-arrow-closed,
        .category.open .tree-arrow-open {
          position: absolute;
          left: 20px;
          top: 7px;
          width: 14px;
          height: 14px;
          background: transparent url("img/icon-chevron-white.svg") no-repeat center center;
          background-size: 14px 8px;
          margin: 0 10px 0 0;
          color: transparent;
        }

        .category.open .tree-arrow-open {
          -webkit-transform: rotate(90deg);
          -moz-transform: rotate(90deg);
          -ms-transform: rotate(90deg);
          -o-transform: rotate(90deg);
          transform: rotate(90deg);
        }

        .category.open .tree-arrow-closed {
            display: none;
        }

        .category.closed .tree-arrow-open {
            display: none;
        }

        /*.category-item {
            padding-left: 30px;
        }
*/

        .category-item {
          color: rgba(255,255,255,.4);
          background-color: rgba(0,0,0,0);
          transition: background-color 0.2s;
          cursor: pointer;
          line-height: 20px;
          padding-top: 5px;
          padding-bottom: 5px;
        }

        .category-item:hover {
          background-color: rgba(0,0,0,.1);
        }

        .category-item.selected {
          color: #FFFFFF;
          border-radius: 0;
          background: #00B4F0 !important;
        }

        .category-caption {
          font-family: "montserrat-light", sans-serif;
          font-size: 16px;
          line-height: 20px;
          padding: 5px 20px 5px 45px;
          color: #FFFFFF;
          display: block;
          cursor: pointer;
        }

        .category-item-caption {
          font-family: "montserrat-regular", sans-serif;
          font-size: 12px;
          line-height: 20px;
          padding: 10px 10px 10px 45px;
        }

    </style>

    <template>
        <template is="dom-repeat" id="categories" items="[[categories]]" as="category">
            <div id="[[category.name]]" class="category closed" on-click="_categoryClicked">
                <i class="icon tree-arrow-closed">&#xe7be;</i>
                <i class="icon tree-arrow-open">&#xe7bc;</i>
                <span class="category-caption">[[category.caption]]</span>

                <div class="category-items">
                    <template is="dom-repeat" items="[[category.demos]]" as="demo">
                        <div id="[[demo.component]]" class="category-item" on-click="_itemClicked">
                            <span class="category-item-caption">[[demo.caption]]</span>
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </template>

    <script>
        Polymer({
            is: 'menu-tree',

            properties: {
                selectedCategory: String,

                selectedItem: {
                    type: String,
                    notify: true,
                    observer: '_selectedItemChanged'
                },

                categories: Array
            },

            _categoryClicked: function (event, detail, sender) {
                var selectedCategory = this._getElementForId(event.model.category.name);

                if (selectedCategory.classList.contains("closed")) {
                    selectedCategory.classList.remove("closed");
                    selectedCategory.classList.add("open");
                } else {
                    selectedCategory.classList.add("closed");
                    selectedCategory.classList.remove("open");
                }
            },

            _itemClicked: function (event, detail, sender) {
                event.stopPropagation();
                this.selectedCategory = this.$.categories.modelForElement(event.target).category.name;
                this.selectedItem = event.model.demo.component;
            },

            _selectedItemChanged: function (newValue, oldValue) {
                var categoryName = this._getCategoryForItem(newValue);
                this.selectedCategory = categoryName;

                this.async(function () {
                    //delayed DOM manipulation
                    this._openCategoryForItem(this.selectedCategory);

                    var selectedItemElement = this._getElementForId(newValue)

                    var oldSelectedItemElement = this._getElementForId(oldValue)
                    if (oldSelectedItemElement !== undefined && oldSelectedItemElement !== null) {
                        oldSelectedItemElement.classList.remove("selected");
                    }

                    selectedItemElement.classList.add("selected");
                }, 1);

            },

            _getCategoryForItem: function (newItem) {
                if (typeof newItem !== 'undefined' && newItem !== null) {
                    for (var i = 0; i < this.categories.length; i++) {
                        var category = this.categories[i];
                        for (var j = 0; j < category.demos.length; j++) {
                            var demo = category.demos[j];
                            if (demo.component === newItem) {
                                return category.name;

                            }
                        }
                    }
                }
                console.log('Category not found for item: ' + newItem);
                this.selectedItem = undefined;
            },

            _openCategoryForItem: function (categoryName) {
                var categoryElement = this._getElementForId(categoryName);
                categoryElement.classList.remove("closed");
                categoryElement.classList.add("open");
            },

            _getElementForId: function (id) {
                //so that we can accept numeric ids, like 3d
                return this.querySelector("[id='" + id + "']");
            }
        });
    </script>
</dom-module>
